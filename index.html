<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Flappy Ball - 3D ØªØµÙ…ÙŠÙ… Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
  <style>
    /* RESET */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      user-select: none;
    }

    body {
      background: linear-gradient(135deg, #141e30, #243b55);
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
      perspective: 1200px;
    }

    canvas {
      background: #0d1b2a;
      border-radius: 15px;
      box-shadow: 0 0 20px #00aaff80 inset, 0 15px 35px rgba(0, 170, 255, 0.5);
      display: block;
      margin: 20px auto;
      border: none;
      transform-style: preserve-3d;
      transition: transform 0.3s ease;
    }
    canvas:hover {
      transform: rotateY(5deg) rotateX(5deg) scale(1.05);
      box-shadow: 0 0 40px #00c8ffaa inset, 0 25px 50px rgba(0, 200, 255, 0.8);
    }

    h2 {
      margin-bottom: 15px;
      text-shadow: 0 0 10px #00c8ffbb;
    }

    /* Ø§Ù„Ø´Ø§Ø´Ø§Øª (start, gameover, store) */
    .screen {
      background: rgba(10, 20, 35, 0.85);
      padding: 30px 40px;
      border-radius: 20px;
      box-shadow: 0 0 25px #00aaffcc;
      max-width: 360px;
      width: 100%;
      margin: 0 auto 30px;
      transform-style: preserve-3d;
      backface-visibility: hidden;
      transition: opacity 0.3s ease;
      font-weight: 600;
      display: none;
    }
    .screen.active {
      display: block;
      animation: fadeIn 0.5s ease forwards;
    }

    @keyframes fadeIn {
      from {opacity: 0; transform: translateY(15px);}
      to {opacity: 1; transform: translateY(0);}
    }

    input[type="text"] {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: none;
      font-size: 18px;
      font-weight: 600;
      color: #222;
      box-shadow: inset 0 0 8px #00aaff66;
      transition: box-shadow 0.3s ease;
    }
    input[type="text"]:focus {
      outline: none;
      box-shadow: inset 0 0 15px #00d4ffcc;
    }

    button {
      background: linear-gradient(145deg, #00b4ff, #005f99);
      border: none;
      padding: 15px 30px;
      margin: 15px 10px 0 10px;
      border-radius: 14px;
      color: #e0f7ff;
      font-weight: 700;
      font-size: 17px;
      cursor: pointer;
      box-shadow:
        0 5px 10px #004f7f,
        inset 0 -3px 7px #00d8ff;
      transition: all 0.3s ease;
      user-select: none;
      transform-style: preserve-3d;
      position: relative;
    }
    button:hover {
      background: linear-gradient(145deg, #00e0ff, #0085cc);
      box-shadow:
        0 8px 20px #00bfff,
        inset 0 -3px 10px #00f0ff;
      transform: translateY(-3px) scale(1.05);
      text-shadow: 0 0 6px #aaffff;
    }
    button:active {
      transform: translateY(1px) scale(0.97);
      box-shadow:
        0 3px 5px #004260,
        inset 0 -1px 3px #00a6cc;
    }

    #coinsDisplay, #storeCoins {
      margin-top: 10px;
      font-size: 20px;
      color: #00dfff;
      text-shadow: 0 0 15px #00c8ffbb;
      font-weight: 700;
    }

    #storeItems {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
    }

    .store-item {
      background: linear-gradient(145deg, #122e4a, #0b2342);
      border-radius: 15px;
      padding: 12px;
      width: 110px;
      box-shadow:
        0 3px 8px rgba(0, 170, 255, 0.4),
        inset 0 0 10px #004f7f;
      user-select: none;
      color: #80dfff;
      font-weight: 700;
      text-align: center;
      transition: transform 0.3s ease;
      cursor: pointer;
      position: relative;
      perspective: 800px;
    }
    .store-item:hover {
      transform: scale(1.1) rotateY(10deg);
      box-shadow:
        0 6px 20px #00e0ffcc,
        inset 0 0 15px #0099cc;
    }
    .store-item img {
      border-radius: 12px;
      width: 80px;
      height: 80px;
      box-shadow: 0 0 10px #00cfffcc;
      user-select: none;
    }
    .store-item button {
      margin-top: 10px;
      width: 100%;
      background: linear-gradient(145deg, #007bb8, #004c6b);
      box-shadow: inset 0 0 5px #00b0ffcc;
      color: #d0e9ff;
      font-weight: 700;
      font-size: 14px;
      padding: 8px 0;
      border-radius: 10px;
      transition: background 0.3s ease;
      user-select: none;
    }
    .store-item button:hover {
      background: linear-gradient(145deg, #00aaff, #006aaf);
      box-shadow: inset 0 0 15px #00dfffcc;
      color: #e0f7ff;
    }

    /* Ù†Øµ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù‚Ù„ÙˆØ¨ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ù†ÙØ³ */
    #gameCanvas + div {
      margin-top: 10px;
      color: #00dfff;
      text-shadow: 0 0 12px #00c8ffbb;
      font-weight: 700;
    }

  </style>
</head>
<body>

<canvas id="gameCanvas" width="360" height="480"></canvas>

<div id="startScreen" class="screen active" tabindex="0" aria-label="Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©">
  <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Flappy Ball</h2>
  <input type="text" id="playerName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" aria-required="true" />
  <div id="coinsDisplay" aria-live="polite">ğŸ’° 0</div>
  <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  <button onclick="openStore()">Ø§Ù„Ù…ØªØ¬Ø±</button>
</div>

<div id="gameOverScreen" class="screen" tabindex="0" aria-label="Ø´Ø§Ø´Ø© Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©">
  <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
  <p>Ù†ØªÙŠØ¬ØªÙƒ: <span id="finalScore"></span></p>
  <p>Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©: <span id="bestScore"></span></p>
  <button onclick="restartGame()">Ø¥Ø¹Ø§Ø¯Ø©</button>
</div>

<div id="storeScreen" class="screen" tabindex="0" aria-label="Ø´Ø§Ø´Ø© Ø§Ù„Ù…ØªØ¬Ø±">
  <h2>Ø§Ù„Ù…ØªØ¬Ø±</h2>
  <p>ğŸ’° <span id="storeCoins">0</span></p>
  <div id="storeItems"></div>
  <button onclick="closeStore()">Ø±Ø¬ÙˆØ¹</button>
</div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const startScreen = document.getElementById("startScreen");
  const gameOverScreen = document.getElementById("gameOverScreen");
  const storeScreen = document.getElementById("storeScreen");
  const finalScoreDisplay = document.getElementById("finalScore");
  const bestScoreDisplay = document.getElementById("bestScore");
  const coinsDisplay = document.getElementById("coinsDisplay");
  const storeCoins = document.getElementById("storeCoins");
  const storeItems = document.getElementById("storeItems");
  const playerNameInput = document.getElementById("playerName");

  let gameStarted = false;
  let score = 0;
  let bestScore = parseInt(localStorage.getItem("bestScore")) || 0;
  let coins = parseInt(localStorage.getItem("coins")) || 0;
  let selectedCharacter = 0;
  let ownedCharacters = JSON.parse(localStorage.getItem("ownedCharacters")) || [0];
  let pipes = [];
  let frame = 0;
  let pipeSpeed = 2;
  let lives = 5;

  // Ù†Ø³ØªØ®Ø¯Ù… ØµÙˆØ± pixel art Ù…Ù† API
  const birdImages = Array.from({length: 20}).map((_, i) => {
    const img = new Image();
    img.src = `https://api.dicebear.com/7.x/pixel-art/svg?seed=char${i}`;
    return img;
  });

  const background = new Image();
  background.src = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQthyR3vhdCtHuJAYQDqOi8fCbjWi20TQ5chA&usqp=CAU";

  const bird = {
    x: 60,
    y: 150,
    width: 40,
    height: 40,
    gravity: 1.5,
    velocity: 0,
    jump: -15,
    draw: function () {
      ctx.drawImage(birdImages[selectedCharacter], this.x, this.y, this.width, this.height);
    },
    update: function () {
      this.velocity += this.gravity;
      this.y += this.velocity;
      if (this.y + this.height > canvas.height) {
        loseLife();
      }
      this.draw();
    },
    flap: function () {
      this.velocity = this.jump;
    }
  };

  function createPipe() {
    let topHeight = Math.floor(Math.random() * 180) + 50;
    pipes.push({ x: canvas.width, topHeight });
  }

  function updatePipes() {
    for (let i = 0; i < pipes.length; i++) {
      let p = pipes[i];
      p.x -= pipeSpeed;

      // Ø£Ù†Ø§Ø¨ÙŠØ¨ Ø¨ØªØ¯Ø±Ø¬ Ø£Ù„ÙˆØ§Ù† ÙŠØ¹Ø·ÙŠ Ø¥Ø­Ø³Ø§Ø³ 3D
      const gradTop = ctx.createLinearGradient(p.x, 0, p.x + 50, p.topHeight);
      gradTop.addColorStop(0, '#0f6210');
      gradTop.addColorStop(1, '#38a82b');

      const gradBottom = ctx.createLinearGradient(p.x, p.topHeight + 120, p.x + 50, canvas.height);
      gradBottom.addColorStop(0, '#0f6210');
      gradBottom.addColorStop(1, '#38a82b');

      ctx.fillStyle = gradTop;
      ctx.fillRect(p.x, 0, 50, p.topHeight);

      ctx.fillStyle = gradBottom;
      ctx.fillRect(p.x, p.topHeight + 120, 50, canvas.height - p.topHeight - 120);

      // ØªØ£Ø«ÙŠØ± Ø¸Ù„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ø§Ø¨ÙŠØ¨
      ctx.shadowColor = "rgba(0, 100, 0, 0.5)";
      ctx.shadowBlur = 10;
      ctx.shadowOffsetX = 2;
      ctx.shadowOffsetY = 2;

      if (
        bird.x < p.x + 50 &&
        bird.x + bird.width > p.x &&
        (
          bird.y < p.topHeight ||
          bird.y + bird.height > p.topHeight + 120
        )
      ) {
        loseLife();
        pipes.splice(i, 1);
        i--;
      }

      if (p.x + 50 === bird.x) {
        score++;
        coins++;
        if (score % 5 === 0) pipeSpeed += 0.3;
      }

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¸Ù„
      ctx.shadowColor = "transparent";
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }

    pipes = pipes.filter(p => p.x + 50 > 0);
  }

  function drawBackground() {
    let bgX = -(frame * pipeSpeed) % canvas.width;
    ctx.drawImage(background, bgX, 0, canvas.width, canvas.height);
    ctx.drawImage(background, bgX + canvas.width, 0, canvas.width, canvas.height);
  }

  function drawScore() {
    ctx.fillStyle = "#00dfff";
    ctx.font = "20px 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
    ctx.shadowColor = "#00c8ffbb";
    ctx.shadowBlur = 12;
    ctx.fillText("Ø§Ù„Ù†Ù‚Ø§Ø·: " + score, 15, 28);
    ctx.fillText("Ø§Ù„Ø¹Ù…Ù„Ø§Øª: " + coins, 15, 58);
    ctx.fillText("â¤ï¸: " + lives, 15, 88);
    ctx.shadowBlur = 0;
  }

  function gameLoop() {
    if (!gameStarted) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    bird.update();
    if (frame % 90 === 0) createPipe();
    updatePipes();
    drawScore();
    frame++;
    requestAnimationFrame(gameLoop);
  }

  function loseLife() {
    lives--;
    if (lives <= 0) {
      endGame();
    } else {
      bird.velocity = 0;
      bird.y = 150;
    }
  }

  function startGame() {
    const playerName = playerNameInput.value.trim();
    if (!playerName) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");

    score = 0;
    lives = 5;
    pipes = [];
    frame = 0;
    pipeSpeed = 2;
    bird.y = 150;
    bird.velocity = 0;
    gameStarted = true;
    switchScreen(null);
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    gameStarted = false;
    finalScoreDisplay.innerText = score;
    bestScore = Math.max(bestScore, score);
    localStorage.setItem("bestScore", bestScore);
    localStorage.setItem("coins", coins);
    bestScoreDisplay.innerText = bestScore;
    switchScreen(gameOverScreen);
  }

  function restartGame() {
    switchScreen(startScreen);
  }

  function switchScreen(target) {
    [startScreen, gameOverScreen, storeScreen].forEach(screen => screen.classList.remove("active"));
    if (target) target.classList.add("active");
    updateDisplays();
  }

  function updateDisplays() {
    coinsDisplay.innerText = `ğŸ’° ${coins}`;
    storeCoins.innerText = coins;
  }

  function openStore() {
    switchScreen(storeScreen);
    renderStoreItems();
  }

  function closeStore() {
    switchScreen(startScreen);
  }

  const storeData = [
    { id: 1, name: "Ø´Ø®ØµÙŠØ© 1", price: 50, imgIndex: 1 },
    { id: 2, name: "Ø´Ø®ØµÙŠØ© 2", price: 100, imgIndex: 2 },
    { id: 3, name: "Ø´Ø®ØµÙŠØ© 3", price: 150, imgIndex: 3 },
    { id: 4, name: "Ø´Ø®ØµÙŠØ© 4", price: 200, imgIndex: 4 },
  ];

  function renderStoreItems() {
    storeItems.innerHTML = "";
    storeData.forEach(item => {
      const owned = ownedCharacters.includes(item.id);
      const div = document.createElement("div");
      div.className = "store-item";
      div.innerHTML = `
        <img src="${birdImages[item.imgIndex].src}" alt="${item.name}" />
        <div>${item.name}</div>
        <button ${owned ? "disabled" : ""} data-id="${item.id}" data-price="${item.price}">
          ${owned ? "Ù…Ù…Ù„ÙˆÙƒ" : `Ø§Ø´ØªØ±ÙŠ Ø¨Ù€ ${item.price}`}
        </button>
      `;
      storeItems.appendChild(div);
    });

    storeItems.querySelectorAll("button").forEach(btn => {
      btn.addEventListener("click", buyItem);
    });
  }

  function buyItem(e) {
    const btn = e.target;
    const id = parseInt(btn.dataset.id);
    const price = parseInt(btn.dataset.price);
    if (coins >= price) {
      coins -= price;
      ownedCharacters.push(id);
      localStorage.setItem("ownedCharacters", JSON.stringify(ownedCharacters));
      localStorage.setItem("coins", coins);
      updateDisplays();
      renderStoreItems();
      alert("ØªÙ… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!");
    } else {
      alert("Ù„Ø§ ØªÙ…Ù„Ùƒ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ©!");
    }
  }

  window.addEventListener("keydown", e => {
    if (gameStarted && e.code === "Space") {
      bird.flap();
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù…Ù„Ø§Øª ÙˆØ§Ù„Ù†Ù‚Ø§Ø· ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  updateDisplays();

</script>
</body>
</html>
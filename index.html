<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flappy Ball</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Tahoma', sans-serif;
    }
    body {
      background: #000;
      color: #fff;
      text-align: center;
    }
    canvas {
      background: #222;
      display: block;
      margin: 20px auto;
      border: 2px solid #fff;
    }
    .screen {
      display: none;
      padding: 20px;
    }
    .screen.active {
      display: block;
    }
    input {
      padding: 10px;
      margin: 10px;
      width: 200px;
      font-size: 16px;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px;
      cursor: pointer;
    }
    #storeItems {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    .store-item {
      background: #444;
      padding: 10px;
      border-radius: 5px;
      width: 100px;
    }
    .store-item img {
      width: 80px;
      height: 80px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

<canvas id="gameCanvas" width="360" height="480"></canvas>

<div id="startScreen" class="screen active">
  <h2>Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Flappy Ball</h2>
  <input type="text" id="playerName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ">
  <div id="coinsDisplay">ğŸ’° 0</div>
  <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
  <button onclick="openStore()">Ø§Ù„Ù…ØªØ¬Ø±</button>
</div>

<div id="gameOverScreen" class="screen">
  <h2>Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©</h2>
  <p>Ù†ØªÙŠØ¬ØªÙƒ: <span id="finalScore"></span></p>
  <p>Ø£ÙØ¶Ù„ Ù†ØªÙŠØ¬Ø©: <span id="bestScore"></span></p>
  <button onclick="restartGame()">Ø¥Ø¹Ø§Ø¯Ø©</button>
</div>

<div id="storeScreen" class="screen">
  <h2>Ø§Ù„Ù…ØªØ¬Ø±</h2>
  <p>ğŸ’° <span id="storeCoins">0</span></p>
  <div id="storeItems"></div>
  <button onclick="closeStore()">Ø±Ø¬ÙˆØ¹</button>
</div>

<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const startScreen = document.getElementById("startScreen");
  const gameOverScreen = document.getElementById("gameOverScreen");
  const storeScreen = document.getElementById("storeScreen");
  const finalScoreDisplay = document.getElementById("finalScore");
  const bestScoreDisplay = document.getElementById("bestScore");
  const coinsDisplay = document.getElementById("coinsDisplay");
  const storeCoins = document.getElementById("storeCoins");
  const storeItems = document.getElementById("storeItems");
  const playerNameInput = document.getElementById("playerName");

  let gameStarted = false;
  let score = 0;
  let bestScore = localStorage.getItem("bestScore") || 0;
  let coins = parseInt(localStorage.getItem("coins")) || 0;
  let selectedCharacter = 0;
  let ownedCharacters = JSON.parse(localStorage.getItem("ownedCharacters")) || [0];
  let pipes = [];
  let frame = 0;
  let pipeSpeed = 2;
  let lives = 5;

  const birdImages = Array.from({length: 20}).map((_, i) => {
    const img = new Image();
    img.src = `https://api.dicebear.com/7.x/pixel-art/svg?seed=char${i}`;
    return img;
  });

  const background = new Image();
  background.src = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQthyR3vhdCtHuJAYQDqOi8fCbjWi20TQ5chA&usqp=CAU";

  const bird = {
    x: 60,
    y: 150,
    width: 40,
    height: 40,
    gravity: 1.5,
    velocity: 0,
    jump: -15,
    draw: function () {
      ctx.drawImage(birdImages[selectedCharacter], this.x, this.y, this.width, this.height);
    },
    update: function () {
      this.velocity += this.gravity;
      this.y += this.velocity;
      if (this.y + this.height > canvas.height) {
        loseLife();
      }
      this.draw();
    },
    flap: function () {
      this.velocity = this.jump;
    }
  };

  function createPipe() {
    let topHeight = Math.floor(Math.random() * 180) + 50;
    pipes.push({ x: canvas.width, topHeight });
  }

  function updatePipes() {
    for (let i = 0; i < pipes.length; i++) {
      let p = pipes[i];
      p.x -= pipeSpeed;

      ctx.fillStyle = "green";
      ctx.fillRect(p.x, 0, 50, p.topHeight);
      ctx.fillRect(p.x, p.topHeight + 120, 50, canvas.height - p.topHeight - 120);

      if (
        bird.x < p.x + 50 &&
        bird.x + bird.width > p.x &&
        (
          bird.y < p.topHeight ||
          bird.y + bird.height > p.topHeight + 120
        )
      ) {
        loseLife();
        pipes.splice(i, 1);
        i--;
      }

      if (p.x + 50 === bird.x) {
        score++;
        coins++;
        if (score % 5 === 0) pipeSpeed += 0.3;
      }
    }

    pipes = pipes.filter(p => p.x + 50 > 0);
  }

  function drawBackground(offset) {
    let bgX = -(frame * pipeSpeed) % canvas.width;
    ctx.drawImage(background, bgX, 0, canvas.width, canvas.height);
    ctx.drawImage(background, bgX + canvas.width, 0, canvas.width, canvas.height);
  }

  function drawScore() {
    ctx.fillStyle = "white";
    ctx.font = "18px Arial";
    ctx.fillText("Ø§Ù„Ù†Ù‚Ø§Ø·: " + score, 10, 20);
    ctx.fillText("Ø§Ù„Ø¹Ù…Ù„Ø§Øª: " + coins, 10, 40);
    ctx.fillText("â¤ï¸: " + lives, 10, 60);
  }

  function gameLoop() {
    if (!gameStarted) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    drawBackground();
    bird.update();
    if (frame % 90 === 0) createPipe();
    updatePipes();
    drawScore();
    frame++;
    requestAnimationFrame(gameLoop);
  }

  function loseLife() {
    lives--;
    if (lives <= 0) {
      endGame();
    } else {
      bird.velocity = 0;
      bird.y = 150;
    }
  }

  function startGame() {
    const playerName = playerNameInput.value.trim();
    if (!playerName) return alert("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");

    score = 0;
    lives = 5;
    pipes = [];
    frame = 0;
    pipeSpeed = 2;
    bird.y = 150;
    bird.velocity = 0;
    gameStarted = true;
    switchScreen(null);
    requestAnimationFrame(gameLoop);
  }

  function endGame() {
    gameStarted = false;
    finalScoreDisplay.innerText = score;
    bestScore = Math.max(bestScore, score);
    localStorage.setItem("bestScore", bestScore);
    localStorage.setItem("coins", coins);
    bestScoreDisplay.innerText = bestScore;
    switchScreen(gameOverScreen);
  }

  function restartGame() {
    switchScreen(startScreen);
  }

  function switchScreen(target) {
    [startScreen, gameOverScreen, storeScreen].forEach(screen => screen.classList.remove("active"));
    if (target) target.classList.add("active");
    updateDisplays();
  }

  function updateDisplays() {
    coinsDisplay.innerText = `ğŸ’° ${coins}`;
    storeCoins.innerText = coins;
  }

  function openStore() {
    storeItems.innerHTML = "";
    for (let i = 0; i < birdImages.length; i++) {
      const item = document.createElement("div");
      item.className = "store-item";
      item.innerHTML = `<img src="${birdImages[i].src}" /><br/>${ownedCharacters.includes(i) ? "âœ…" : `ğŸª™ ${(i+1)*10}`}<br/><button>${ownedCharacters.includes(i) ? "Ø§Ø®ØªØ±" : "Ø´Ø±Ø§Ø¡"}</button>`;
      item.querySelector("button").onclick = () => {
        if (ownedCharacters.includes(i)) {
          selectedCharacter = i;
        } else if (coins >= (i+1)*10) {
          coins -= (i+1)*10;
          ownedCharacters.push(i);
          localStorage.setItem("ownedCharacters", JSON.stringify(ownedCharacters));
          selectedCharacter = i;
        } else {
          alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ©");
        }
        localStorage.setItem("coins", coins);
        updateDisplays();
        openStore();
      };
      storeItems.appendChild(item);
    }
    switchScreen(storeScreen);
  }

  function closeStore() {
    switchScreen(startScreen);
  }

  document.addEventListener("keydown", e => {
    if (e.code === "Space") bird.flap();
  });
  document.addEventListener("touchstart", () => {
    if (gameStarted) bird.flap();
  });

  window.onload = () => {
    updateDisplays();
  };
</script>

</body>
</html>
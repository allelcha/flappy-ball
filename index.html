<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Flappy Ball 3D - Ù„Ø¹Ø¨Ø© Ù…ØªÙƒØ§Ù…Ù„Ø© Ù…Ø¹ Ù…ØªØ¬Ø± ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      font-family: Tahoma, sans-serif;
      background: #000;
      color: white;
      user-select: none;
      direction: rtl;
    }
    #overlay {
      position: absolute;
      top: 0; right: 0; left: 0; bottom: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.85);
      z-index: 10;
    }
    #gameUI {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 8;
      font-size: 18px;
      user-select: none;
      background: rgba(0,0,0,0.4);
      padding: 8px 15px;
      border-radius: 10px;
      max-width: 250px;
    }
    #gameUI > div {
      margin-bottom: 6px;
    }
    button, select {
      margin: 10px 5px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 6px;
      border: none;
      outline: none;
      background: #222;
      color: white;
      transition: background 0.3s;
    }
    button:hover, select:hover {
      background: #555;
    }
    #store {
      position: absolute;
      bottom: 20px;
      right: 50%;
      transform: translateX(50%);
      background: rgba(20,20,20,0.8);
      padding: 10px 20px;
      border-radius: 10px;
      display: flex;
      gap: 15px;
      z-index: 8;
      user-select: none;
      max-width: 90vw;
      overflow-x: auto;
    }
    #store button {
      background: #444;
      min-width: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      font-size: 14px;
      gap: 6px;
    }
    #store button.active {
      background: #008800;
    }
    #gameCanvas {
      display: block;
      position: absolute;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      touch-action: none;
    }
    #leaderboard {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(0,0,0,0.6);
      padding: 10px 15px;
      border-radius: 10px;
      max-width: 300px;
      font-size: 16px;
      z-index: 9;
      user-select: none;
    }
    #leaderboard h3 {
      margin-top: 0;
      margin-bottom: 10px;
      border-bottom: 1px solid #555;
      padding-bottom: 5px;
    }
    #leaderboard ol {
      padding-left: 20px;
      margin: 0;
    }
  </style>
</head>
<body>

<div id="overlay">
  <h1>Flappy Ball 3D</h1>
  <input type="text" id="playerName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ" style="padding:10px; font-size:16px; width: 250px;">
  <button onclick="startGame()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<div id="gameUI" style="display:none;">
  <div>Ø§Ù„Ù„Ø§Ø¹Ø¨: <span id="displayName"></span></div>
  <div>ğŸ† Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="score">0</span></div>
  <div>ğŸ’° Ø§Ù„Ø¹Ù…Ù„Ø§Øª: <span id="coins">0</span></div>
  <div>ğŸ“Š Ø£Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø©: <span id="bestScore">0</span></div>
  <div>ğŸ¯ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·: <span id="totalScore">0</span></div>
  <div>ğŸ’µ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„Ø§Øª: <span id="totalCoins">0</span></div>
</div>

<div id="store" style="display:none;">
  <!-- Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯Ù‡Ø§ Ø¨Ø§Ù„Ù€JS -->
</div>

<div id="leaderboard" style="display:none;">
  <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙØ¶Ù„ÙŠØ©</h3>
  <ol id="leaderboardList"></ol>
</div>

<canvas id="gameCanvas"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r148/three.min.js"></script>
<script>
  let scene, camera, renderer;
  let player, obstacles = [];
  let score = 0, coins = 0;
  let velocity = 0.06, gameStarted = false;
  let isDragging = false, lastTouchX = 0;
  let playerName = "";
  let selectedModel = 'sphere';
  let ballColor = '#ff3333';
  let obstacleTimer, bgHue = 0;
  let currentStage = 0;

  const sounds = {
    coin: new Audio('https://freesound.org/data/previews/341/341695_6247035-lq.mp3'),
    hit: new Audio('https://freesound.org/data/previews/256/256113_3263906-lq.mp3'),
    move: new Audio('https://freesound.org/data/previews/235/235940_3988707-lq.mp3')
  };
  for (let key in sounds) {
    sounds[key].volume = 0.2;
  }

  const overlay = document.getElementById('overlay');
  const scoreDisplay = document.getElementById('score');
  const coinsDisplay = document.getElementById('coins');
  const gameUI = document.getElementById('gameUI');
  const displayName = document.getElementById('displayName');
  const store = document.getElementById('store');
  const leaderboardDiv = document.getElementById('leaderboard');
  const leaderboardList = document.getElementById('leaderboardList');
  const bestScoreDisplay = document.getElementById('bestScore');
  const totalScoreDisplay = document.getElementById('totalScore');
  const totalCoinsDisplay = document.getElementById('totalCoins');

  // Ù…ÙˆØ¯ÙŠÙ„Ø§Øª Ø´Ø®ØµÙŠØ§Øª 3D
  function createModel(type, color) {
    if(player) scene.remove(player);
    let geometry;
    switch(type){
      case 'sphere':
        geometry = new THREE.SphereGeometry(0.5, 32, 32);
        break;
      case 'cube':
        geometry = new THREE.BoxGeometry(1,1,1);
        break;
      case 'cone':
        geometry = new THREE.ConeGeometry(0.5, 1, 32);
        break;
      default:
        geometry = new THREE.SphereGeometry(0.5, 32, 32);
    }
    const material = new THREE.MeshStandardMaterial({ color });
    player = new THREE.Mesh(geometry, material);
    player.position.z = -5;
    player.position.y = 0;
    player.position.x = 0;
    scene.add(player);
  }

  function init(){
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer({canvas: document.getElementById('gameCanvas'), antialias: true});
    renderer.setSize(window.innerWidth, window.innerHeight);

    const light = new THREE.PointLight(0xffffff, 1.2, 100);
    light.position.set(10, 10, 10);
    scene.add(light);

    const ambient = new THREE.AmbientLight(0x404040);
    scene.add(ambient);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(50, 50),
      new THREE.MeshStandardMaterial({ color: 0x222222, side: THREE.DoubleSide })
    );
    ground.rotation.x = Math.PI / 2;
    ground.position.y = -2;
    scene.add(ground);

    createModel(selectedModel, ballColor);

    camera.position.z = 7;
  }

  function createObstacle() {
    const height = Math.random() * 3 + 1;
    const geometry = new THREE.BoxGeometry(1, height, 1);
    const material = new THREE.MeshStandardMaterial({ color: 0x00ff00 });
    const obstacle = new THREE.Mesh(geometry, material);
    obstacle.position.z = -5;
    obstacle.position.x = (Math.random() - 0.5) * 6;
    obstacle.position.y = 4 + height / 2;
    scene.add(obstacle);
    obstacles.push(obstacle);
  }

  function updateObstacles() {
    for (let i = obstacles.length - 1; i >= 0; i--) {
      obstacles[i].position.y -= velocity;
      if (obstacles[i].position.y < -3) {
        scene.remove(obstacles[i]);
        obstacles.splice(i, 1);
        score++;
        coins++;
        updateUI();
        playSound('coin');
        if(score % 30 === 0) {
          nextStage();
        }
      }
    }
  }

  function nextStage() {
    currentStage++;
    bgHue = (bgHue + 120) % 360;
    alert("Ù…Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©! " + (currentStage + 1));
  }

  function checkCollision() {
    for (let obs of obstacles) {
      const dx = player.position.x - obs.position.x;
      const dy = player.position.y - obs.position.y;
      if (Math.abs(dx) < 0.75 && Math.abs(dy) < obs.geometry.parameters.height / 2 + 0.5) {
        gameOver();
        return;
      }
    }
  }

  function gameOver() {
    gameStarted = false;
    clearInterval(obstacleTimer);
    saveScore();
    overlay.style.display = 'flex';
    leaderboardDiv.style.display = 'block';
    updateLeaderboard();
    alert('Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ù†ØªÙŠØ¬ØªÙƒ: ' + score);
  }

  function updateUI(){
    scoreDisplay.textContent = score;
    coinsDisplay.textContent = coins;
    const bestScore = Math.max(score, getBestScore());
    bestScoreDisplay.textContent = bestScore;
    totalScoreDisplay.textContent = getTotalScore();
    totalCoinsDisplay.textContent = getTotalCoins();
  }

  function getBestScore() {
    return parseInt(localStorage.getItem('bestScore') || '0');
  }

  function getTotalScore() {
    return parseInt(localStorage.getItem('totalScore') || '0');
  }

  function getTotalCoins() {
    return parseInt(localStorage.getItem('totalCoins') || '0');
  }

  function saveScore() {
    let best = getBestScore();
    if(score > best) {
      localStorage.setItem('bestScore', score);
    }
    let total = getTotalScore() + score;
    localStorage.setItem('totalScore', total);
    let totalC = getTotalCoins() + coins;
    localStorage.setItem('totalCoins', totalC);

    saveLeaderboardScore(playerName, score);
  }

  // Ù„ÙˆØ­Ø© Ø§Ù„Ø£ÙØ¶Ù„ÙŠØ©
  function saveLeaderboardScore(name, score) {
    if (!name) return;
    let leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
    leaderboard.push({name, score});
    leaderboard.sort((a,b) => b.score - a.score);
    leaderboard = leaderboard.slice(0,5); // Ø£Ø¹Ù„Ù‰ 5 ÙÙ‚Ø·
    localStorage.setItem('leaderboard', JSON.stringify(leaderboard));
  }

  function updateLeaderboard() {
    const leaderboard = JSON.parse(localStorage.getItem('leaderboard') || '[]');
    leaderboardList.innerHTML = '';
    leaderboard.forEach((entry, index) => {
      const li = document.createElement('li');
      li.textContent = `${entry.name}: ${entry.score}`;
      leaderboardList.appendChild(li);
    });
  }

  // Ù…ØªØ¬Ø± Ø´Ø®ØµÙŠØ§Øª 3D
  const characters = [
    {type:'sphere', color:'#ff3333', name:'Ø§Ù„ÙƒØ±Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡', price:0},
    {type:'cube', color:'#33ff33', name:'Ø§Ù„Ù…ÙƒØ¹Ø¨ Ø§Ù„Ø£Ø®Ø¶Ø±', price:20},
    {type:'cone', color:'#3333ff', name:'Ø§Ù„Ù…Ø®Ø±ÙˆØ· Ø§Ù„Ø£Ø²Ø±Ù‚', price:30},
  ];

  function buildStore() {
    store.innerHTML = '';
    characters.forEach((char, i) => {
      const btn = document.createElement('button');
      btn.textContent = char.name + (char.price > 0 ? ` - ${char.price} Ø¹Ù…Ù„Ø©` : ' - Ù…Ø¬Ø§Ù†ÙŠ');
      btn.style.color = char.color;
      if(char.type === selectedModel && char.color === ballColor) {
        btn.classList.add('active');
      }
      btn.onclick = () => {
        if(char.price > 0 && coins < char.price) {
          alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø¹Ù…Ù„Ø§Øª ÙƒØ§ÙÙŠØ©!');
          return;
        }
        if(char.price > 0) {
          coins -= char.price;
          updateUI();
        }
        selectedModel = char.type;
        ballColor = char.color;
        createModel(selectedModel, ballColor);
        Array.from(store.children).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      };
      store.appendChild(btn);
    });
  }

  // Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø³Ø­Ø¨
  function onPointerDown(e) {
    isDragging = true;
    lastTouchX = e.clientX || e.touches[0].clientX;
  }
  function onPointerMove(e) {
    if(!isDragging) return;
    const x = e.clientX || e.touches[0].clientX;
    let delta = (x - lastTouchX) / window.innerWidth * 10;
    player.position.x += delta;
    player.position.x = Math.min(Math.max(player.position.x, -3), 3);
    lastTouchX = x;
  }
  function onPointerUp() {
    isDragging = false;
  }

  function animate() {
    if(gameStarted) {
      updateObstacles();
      checkCollision();

      bgHue += 0.5;
      document.body.style.background = `hsl(${bgHue}, 60%, 10%)`;
    }

    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }

  function startGame(){
    const input = document.getElementById('playerName');
    if(!input.value.trim()) {
      alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù…');
      return;
    }
    playerName = input.value.trim();
    overlay.style.display = 'none';
    gameUI.style.display = 'block';
    store.style.display = 'flex';
    leaderboardDiv.style.display = 'block';
    score = 0;
    coins = 0;
    currentStage = 0;
    updateUI();
    buildStore();
    createModel(selectedModel, ballColor);
    obstacles.forEach(o => scene.remove(o));
    obstacles = [];
    gameStarted = true;
    obstacleTimer = setInterval(createObstacle, 1000);

    displayName.textContent = playerName;
  }

  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  window.addEventListener('mousedown', onPointerDown);
  window.addEventListener('mousemove', onPointerMove);
  window.addEventListener('mouseup', onPointerUp);
  window.addEventListener('touchstart', onPointerDown);
  window.addEventListener('touchmove', onPointerMove);
  window.addEventListener('touchend', onPointerUp);

  init();
  animate();
</script>

</body>
</html>